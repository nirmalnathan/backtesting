<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIFTY Pivot Point Detector - Fixed Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: bold;
        }
        .controls {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        label {
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }
        .file-input input {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background-color: white;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn.primary {
            background-color: #3498db;
            color: white;
        }
        .btn.success {
            background-color: #27ae60;
            color: white;
        }
        .btn.secondary {
            background-color: #95a5a6;
            color: white;
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-weight: bold;
            text-align: center;
            display: none;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .pivot-stats {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        .stat-box {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            height: 600px;
            overflow: hidden;
        }
        #chart {
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: grab;
            width: 100%;
            height: 100%;
        }
        #chart:active {
            cursor: grabbing;
        }
        .zoom-controls {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .range-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
        }
        .range-control label {
            font-size: 11px;
            min-width: 60px;
        }
        .range-control input {
            width: 80px;
        }
        .timeframe-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .process-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .step-indicator {
            font-size: 12px;
            color: #666;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>NIFTY Pivot Point Detector - Fixed Version</h1>
        
        <div class="controls">
            <div class="file-input">
                <label for="csvFile">Upload CSV File:</label>
                <input type="file" id="csvFile" accept=".csv" />
            </div>

        <!-- Simple Backtest Section -->
        <div class="simple-backtest-section" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin: 20px 0;">
            <h2>Simple Backtest Engine</h2>
            
            <div class="rule-configuration" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6;">
                <h3>Trading Rules Configuration</h3>
                
                <div class="rule-category" style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #6c757d; font-size: 14px; font-weight: bold;">Entry Rules</h4>
                    <div class="rule-item" style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px 12px; background: white; border-radius: 5px; border: 1px solid #e9ecef;">
                        <input type="checkbox" id="entryLphLpl" checked style="margin-right: 10px; transform: scale(1.2);">
                        <label for="entryLphLpl" style="flex: 1; margin: 0; font-size: 14px; color: #495057; cursor: pointer;">LPH Break Entry (LONG above LPH, SHORT below LPL)</label>
                    </div>
                    <div class="rule-item" style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px 12px; background: white; border-radius: 5px; border: 1px solid #e9ecef;">
                        <input type="checkbox" id="gapHandling" checked style="margin-right: 10px; transform: scale(1.2);">
                        <label for="gapHandling" style="flex: 1; margin: 0; font-size: 14px; color: #495057; cursor: pointer;">Gap Handling (Enter at market open if gap beyond trigger)</label>
                    </div>
                </div>
                
                <div class="rule-category" style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #6c757d; font-size: 14px; font-weight: bold;">Exit Rules</h4>
                    <div class="rule-item" style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px 12px; background: white; border-radius: 5px; border: 1px solid #e9ecef;">
                        <input type="checkbox" id="stopLoss" checked style="margin-right: 10px; transform: scale(1.2);">
                        <label for="stopLoss" style="flex: 1; margin: 0; font-size: 14px; color: #495057; cursor: pointer;">Stop Loss:</label>
                        <div style="display: flex; align-items: center; gap: 8px; margin-left: 10px;">
                            <input type="number" id="stopLossPercent" value="0.3" min="0.1" max="5.0" step="0.1" style="width: 60px; padding: 4px 8px; border: 1px solid #ced4da; border-radius: 3px; font-size: 14px; text-align: center;">
                            <span style="font-size: 14px; color: #6c757d;">% against position</span>
                        </div>
                    </div>
                    <div class="rule-item" style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px 12px; background: white; border-radius: 5px; border: 1px solid #e9ecef;">
                        <input type="checkbox" id="eodExit" checked style="margin-right: 10px; transform: scale(1.2);">
                        <label for="eodExit" style="flex: 1; margin: 0; font-size: 14px; color: #495057; cursor: pointer;">End of Day Exit (Mandatory close at day end)</label>
                    </div>
                </div>
                
                <div class="rule-category" style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #6c757d; font-size: 14px; font-weight: bold;">Special Features</h4>
                    <div class="rule-item" style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px 12px; background: white; border-radius: 5px; border: 1px solid #e9ecef;">
                        <input type="checkbox" id="dailyReset" checked style="margin-right: 10px; transform: scale(1.2);">
                        <label for="dailyReset" style="flex: 1; margin: 0; font-size: 14px; color: #495057; cursor: pointer;">Daily Reset (Fresh start each day, no re-trading levels)</label>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                    <button id="resetRules" style="padding: 8px 16px; border: 1px solid #ced4da; border-radius: 4px; background: white; color: #495057; font-size: 12px; cursor: pointer;">Reset to Defaults</button>
                    <button id="saveRules" style="padding: 8px 16px; border: 1px solid #ced4da; border-radius: 4px; background: white; color: #495057; font-size: 12px; cursor: pointer;">Save Configuration</button>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px;">
                <button id="runSimpleBacktest" class="btn primary" style="background-color: #3498db; color: white;">Run Simple Backtest</button>
                <button id="clearSimpleResults" class="btn secondary" style="background-color: #95a5a6; color: white;">Clear Results</button>
            </div>
            
            <div id="backtest-results" style="margin-top: 20px;">
                <!-- Results will be displayed here -->
            </div>
        </div>
            
            <div class="control-group">
                <label for="timeframe">Timeframe:</label>
                <div class="control-row">
                    <select id="timeframe">
                        <option value="1">1 Minute</option>
                        <option value="5" selected>5 Minutes</option>
                        <option value="15">15 Minutes</option>
                        <option value="30">30 Minutes</option>
                        <option value="60">1 Hour</option>
                    </select>
                </div>
                <div class="timeframe-info" id="timeframeInfo"></div>
            </div>
            
            <div class="control-group">
                <label>Process Data:</label>
                <div class="process-controls">
                    <button class="btn primary" id="formBarsBtn">1. Form Bars</button>
                    <button class="btn success" id="detectPivotsBtn" disabled>2. Detect Pivots</button>
                    <span class="step-indicator">← Follow these steps in order</span>
                </div>
            </div>
            
            <div class="control-group">
                <label>Chart Controls:</label>
                <div class="control-row">
                    <button class="btn secondary" id="resetZoomBtn">Reset Zoom</button>
                    <button class="btn secondary" id="fitToScreenBtn">Fit to Screen</button>
                </div>
            </div>
        </div>

        <div class="status" id="status"></div>

        <div class="pivot-stats" id="pivotStats">
            <div class="stat-box">
                <div class="stat-number" id="sphCount">0</div>
                <div class="stat-label">SPH Count</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="splCount">0</div>
                <div class="stat-label">SPL Count</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="lphCount">0</div>
                <div class="stat-label">LPH Count</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="lplCount">0</div>
                <div class="stat-label">LPL Count</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="totalBars">0</div>
                <div class="stat-label">Total Bars</div>
            </div>
        </div>

        <div class="chart-container" id="chartContainer">
            <canvas id="chart"></canvas>
            <div class="zoom-controls">
                <div class="range-control">
                    <label>H-Zoom:</label>
                    <input type="range" id="hZoom" min="0.1" max="5" step="0.1" value="1">
                    <span id="hZoomValue">1.0x</span>
                </div>
                <div class="range-control">
                    <label>V-Scale:</label>
                    <input type="range" id="vScale" min="0.5" max="3" step="0.1" value="1">
                    <span id="vScaleValue">1.0x</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Core Pivot Detection Scripts with error handling -->
    <script>
        // Function to load script and handle errors
        function loadScript(src, name) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log(`✅ ${name} loaded successfully from: ${src}`);
                    resolve();
                };
                script.onerror = () => {
                    console.error(`❌ ${name} failed to load from: ${src}`);
                    reject(new Error(`Failed to load ${name}`));
                };
                document.head.appendChild(script);
            });
        }
        
        // Try different path combinations
        const pathCombinations = [
            // Your current setup
            { base: '/core/', desc: 'Absolute /core/ path' },
            { base: 'core/', desc: 'Relative core/ path' },
            { base: './core/', desc: 'Explicit relative ./core/ path' },
            { base: '../core/', desc: 'Parent directory core/ path' },
            // If files are in same directory
            { base: '', desc: 'Same directory' },
            { base: './', desc: 'Explicit same directory' }
        ];
        
        const scriptFiles = [
            'data-processor.js',
            'pivot-detector.js', 
            'chart-renderer.js',
            'main-controller.js'
        ];
        
        async function tryLoadingScripts() {
            console.log('🔍 Attempting to load scripts from different paths...');
            
            for (const pathConfig of pathCombinations) {
                console.log(`\n📁 Trying ${pathConfig.desc}: "${pathConfig.base}"`);
                
                let allLoaded = true;
                const loadPromises = [];
                
                for (const file of scriptFiles) {
                    const fullPath = pathConfig.base + file;
                    console.log(`  📄 Attempting: ${fullPath}`);
                    
                    loadPromises.push(
                        loadScript(fullPath, file).catch(error => {
                            allLoaded = false;
                            return Promise.resolve(); // Continue with other files
                        })
                    );
                }
                
                await Promise.all(loadPromises);
                
                if (allLoaded) {
                    console.log(`🎉 SUCCESS! All scripts loaded from: ${pathConfig.base}`);
                    
                    // Wait a bit for functions to initialize
                    setTimeout(() => {
                        setupButtons();
                        checkLoadedFunctions();
                    }, 500);
                    
                    return; // Exit - we found working path
                }
            }
            
            console.error('❌ FAILED to load scripts from any path!');
            console.log('\n🔧 TROUBLESHOOTING:');
            console.log('1. Check your file structure:');
            console.log('   Option A: Files in /core/ folder');
            console.log('   Option B: Files in same directory as HTML');
            console.log('2. Check file names exactly match');
            console.log('3. Check browser network tab for exact error');
            
            // Show user-friendly error
            const statusDiv = document.getElementById('status');
            if (statusDiv) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `
                    <strong>JavaScript files not found!</strong><br>
                    Please check:<br>
                    1. Files are in correct directory<br>
                    2. File names match exactly<br>
                    3. Browser console for details
                `;
                statusDiv.style.display = 'block';
            }
        }
        
        function checkLoadedFunctions() {
            console.log('\n🔍 CHECKING LOADED FUNCTIONS:');
            const expectedFunctions = [
                'parseCSV',
                'detectPivots', 
                'drawChart',
                'window.formBarsFunction',
                'window.detectPivotsFunction',
                'window.resetZoomFunction',
                'window.fitToScreenFunction'
            ];
            
            expectedFunctions.forEach(funcName => {
                let exists = false;
                let funcRef = null;
                
                if (funcName.startsWith('window.')) {
                    const prop = funcName.replace('window.', '');
                    exists = typeof window[prop] === 'function';
                    funcRef = window[prop];
                } else {
                    exists = typeof window[funcName] === 'function';
                    funcRef = window[funcName];
                }
                
                console.log(`${exists ? '✅' : '❌'} ${funcName}: ${exists ? 'Available' : 'Missing'}`);
            });
            
            console.log('\n📋 ALL WINDOW PROPERTIES:');
            console.log('Functions containing "form":', Object.keys(window).filter(k => k.toLowerCase().includes('form')));
            console.log('Functions containing "detect":', Object.keys(window).filter(k => k.toLowerCase().includes('detect')));
            console.log('Functions containing "pivot":', Object.keys(window).filter(k => k.toLowerCase().includes('pivot')));
        }
    </script>

    <!-- Simple JavaScript for buttons -->
    <script>
        // Wait for everything to load, then setup buttons
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, attempting to load scripts...');
            tryLoadingScripts();
            
            // Also setup rule configuration
            setTimeout(() => {
                setupRuleConfiguration();
            }, 1500);
        });
        
        function setupButtons() {
            console.log('Setting up button event listeners...');
            
            // Form Bars button
            const formBarsBtn = document.getElementById('formBarsBtn');
            if (formBarsBtn) {
                formBarsBtn.addEventListener('click', function() {
                    console.log('=== Form Bars clicked ===');
                    
                    if (typeof window.formBarsFunction === 'function') {
                        console.log('✅ Calling window.formBarsFunction');
                        window.formBarsFunction();
                    } else if (typeof formBarsInternal === 'function') {
                        console.log('✅ Calling formBarsInternal');
                        formBarsInternal();
                    } else if (typeof window.formBarsInternal === 'function') {
                        console.log('✅ Calling window.formBarsInternal');
                        window.formBarsInternal();
                    } else {
                        console.error('❌ No form bars function found!');
                        console.log('Available functions:', Object.keys(window).filter(k => k.toLowerCase().includes('form')));
                        alert('Form bars function not loaded. Please check console for details.');
                    }
                });
                console.log('✅ Form Bars button setup complete');
            }
            
            // Detect Pivots button
            const detectPivotsBtn = document.getElementById('detectPivotsBtn');
            if (detectPivotsBtn) {
                detectPivotsBtn.addEventListener('click', function() {
                    console.log('=== Detect Pivots clicked ===');
                    
                    if (typeof window.detectPivotsFunction === 'function') {
                        console.log('✅ Calling window.detectPivotsFunction');
                        window.detectPivotsFunction();
                    } else if (typeof detectPivotsInternal === 'function') {
                        console.log('✅ Calling detectPivotsInternal');
                        detectPivotsInternal();
                    } else {
                        console.error('❌ No detect pivots function found!');
                        alert('Detect pivots function not loaded. Please check console for details.');
                    }
                });
                console.log('✅ Detect Pivots button setup complete');
            }
            
            // Reset Zoom button
            const resetZoomBtn = document.getElementById('resetZoomBtn');
            if (resetZoomBtn) {
                resetZoomBtn.addEventListener('click', function() {
                    if (typeof window.resetZoomFunction === 'function') {
                        console.log('✅ Calling window.resetZoomFunction');
                        window.resetZoomFunction();
                    } else {
                        console.error('❌ Reset zoom function not loaded');
                        alert('Reset zoom function not loaded.');
                    }
                });
                console.log('✅ Reset Zoom button setup complete');
            }
            
            // Fit to Screen button
            const fitToScreenBtn = document.getElementById('fitToScreenBtn');
            if (fitToScreenBtn) {
                fitToScreenBtn.addEventListener('click', function() {
                    if (typeof window.fitToScreenFunction === 'function') {
                        console.log('✅ Calling window.fitToScreenFunction');
                        window.fitToScreenFunction();
                    } else {
                        console.error('❌ Fit to screen function not loaded');
                        alert('Fit to screen function not loaded.');
                    }
                });
                console.log('✅ Fit to Screen button setup complete');
            }
            
            console.log('All buttons setup complete!');
        }
    </script>
</body>
</html>